[id="proc_collecting-dev-workspace-operator-metrics-with-prometheus"]
= Collecting {devworkspace} Operator metrics

[role="_abstract"]
To use the in-cluster Prometheus instance to collect, store, and query metrics about the {devworkspace} Operator:

.Prerequisites

* The `devworkspace-controller-metrics` Service is exposing metrics on port `8443`. This is preconfigured by default.

.Procedure

. Create the ServiceMonitor for detecting the Dev Workspace Operator metrics Service
+
.ServiceMonitor
====
[source,yaml,subs="+quotes,+attributes,+macros"]
----
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: devworkspace-controller
  namespace: {prod-namespace} <1>
spec:
  endpoints:
    - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
      interval: 10s <2>
      port: metrics
      scheme: https
      tlsConfig:
        insecureSkipVerify: true
  namespaceSelector:
    matchNames:
      - openshift-operators
  selector:
    matchLabels:
      app.kubernetes.io/name: devworkspace-controller
----
<1> The {prod-short} namespace. The default is `{prod-namespace}`.
<2> The rate at which a target is scraped.
====

. Allow the in-cluster Prometheus instance to detect the ServiceMonitor in the {prod-short} namespace. The default {prod-short} namespace is `{prod-namespace}`.
+
====
[source,terminal,subs="+attributes,quotes"]
----
oc label namespace {prod-namespace} openshift.io/cluster-monitoring=true
----
====

.Verification

. For a fresh installation of {prod-short}, generate metrics by creating a {prod-short} workspace from the Dashboard.

. In the OpenShift web console, navigate to `Observe > Metrics` from the sidebar menu on the left.

. Run a PromQL query to confirm that the metrics are available. For example, enter `devworkspace_started_total` and click `Run queries`.
+
For more metrics, see xref:ref_devworkspace-specific-metrics[].

[TIP]
====

If the {devworkspace} Operator metrics are not available, view the Prometheus container logs for possible RBAC-related errors.

Get the Prometheus pod name:
```
$ oc get pods -l app.kubernetes.io/name=prometheus -n openshift-monitoring -o=jsonpath='{.items[*].metadata.name}'
prometheus-k8s-0
```

Print the last 20 lines of the Prometheus container logs from the Prometheus pod:
```
$ oc logs --tail=20 prometheus-k8s-0 -c prometheus -n openshift-monitoring
```

====
